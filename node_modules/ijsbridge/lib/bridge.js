"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=createBridge;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),msgOffset=1,msgCache=[],msgCallbacks={},bridges={},Message=function e(){(0,_classCallCheck2.default)(this,e),(0,_defineProperty2.default)(this,"index",msgOffset++),(0,_defineProperty2.default)(this,"params",null),(0,_defineProperty2.default)(this,"data",null),(0,_defineProperty2.default)(this,"api",null),(0,_defineProperty2.default)(this,"callback",null)},_post_message=function(e){var r=window.ReactNativeWebView;r&&r.postMessage(JSON.stringify(e))},_bridge_flush=function(){if(0!=msgCache.length){var e=[].concat(msgCache);msgCache.length=0;for(var r=[],a=0;a<e.length;a++){var i=e[a],t=null;i instanceof Message?(t={api:i.api,data:i.data,index:i.index},msgCallbacks[i.index]=i):t=i,r.push(t)}_post_message(r)}},_bridge_request=function(e,r,a){e="c2s_"+e,"function"==typeof r&&(a=r,r=null);var i={};if(r&&"object"==(0,_typeof2.default)(r))for(var t in r)"_"==t.substr(0,1)&&(i[t.substr(1)]=r[t],delete r[t]);var n=new Message;return n.data=r,n.api=e,n.params=i,a&&(n.callback=a),msgCache.push(n),_bridge_flush(),n},_bridge_on=function(e,r){bridges[e="s2c_"+e]||(bridges[e]=[]),bridges[e].push(r)},_receiveMessageHandle_define=function(e){if(!e.api||!bridges[e.api])return!1;for(var r in bridges[e.api])bridges[e.api][r](e,(function(r,a){e.useApi=e.api,delete e.api,e.result=a,e.error=r,msgCache.push(e),_bridge_flush()}))},_receiveMessageHandle_request_callback=function(e){if(!e.index||!msgCallbacks[e.index])return!1;var r=msgCallbacks[e.index];return e.keepAlive||delete msgCallbacks[e.index],r.callback&&r.callback(e),!0},receiveMessageHandle=function(e){var r;try{r=JSON.parse(e.data)}catch(e){return}if(Array.isArray(r))for(var a in r){var i=r[a];_receiveMessageHandle_request_callback(i)||_receiveMessageHandle_define(i)}};function createBridge(){window.addEventListener("message",receiveMessageHandle),document.addEventListener("message",receiveMessageHandle);return _bridge_request("ready","v2",(function(e){})),function(e){e((function(e,r,a){return"function"==typeof r&&(a=r,r=null),_bridge_request(e,r,(function(e){"function"==typeof a&&a(e.error?e.error:null,e.result)}))}),(function(e,r){_bridge_on(e,(function(e,a){r(e.data,(function(e,r){"function"==typeof a&&a(e,r)}))}))}))}}